name: CI

on:
  push:
    branches:
      - master
      - release/**

  pull_request:

env:
  RUSTFLAGS: -Dwarnings

jobs:
  lints:
    name: Lints
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install python dependencies
        run: pip install --upgrade black flake8

      - name: Run Black
        run: black --check --diff tests

      - name: Run Flake8
        run: flake8 tests

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rustfmt, clippy
          override: true

      - name: Cache rust cargo artifacts
        uses: swatinem/rust-cache@v1

      - name: Run cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

      - name: Run clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --all-features --workspace --tests --examples

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache rust cargo artifacts
        uses: swatinem/rust-cache@v1

      - name: Run cargo test
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --workspace --all-features --locked
        env:
          SENTRY_SYMBOLICATOR_GCS_CLIENT_EMAIL: ${{ secrets.SENTRY_SYMBOLICATOR_GCS_CLIENT_EMAIL }}
          SENTRY_SYMBOLICATOR_GCS_PRIVATE_KEY: ${{ secrets.SENTRY_SYMBOLICATOR_GCS_PRIVATE_KEY }}
          SENTRY_SYMBOLICATOR_TEST_AWS_ACCESS_KEY_ID: ${{ secrets.SENTRY_SYMBOLICATOR_TEST_AWS_ACCESS_KEY_ID }}
          SENTRY_SYMBOLICATOR_TEST_AWS_SECRET_ACCESS_KEY: ${{ secrets.SENTRY_SYMBOLICATOR_TEST_AWS_SECRET_ACCESS_KEY }}

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache rust cargo artifacts
        uses: swatinem/rust-cache@v1

      - name: Build rust
        run: cargo build --locked

      - name: Install python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Setup python environment
        run: pip install --upgrade pytest pytest-localserver requests pytest-xdist pytest-icdiff boto3

      - name: Integration tests
        run: pytest -n12 -vv tests/integration

  test_against_latest_sentry:
    name: Sentry-Symbolicator Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Symbolicator
        uses: actions/checkout@v2

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Cache rust cargo artifacts
        uses: swatinem/rust-cache@v1

      - name: Build rust
        run: cargo build --locked

      # Checkout Sentry and run integration tests against latest Symbolicator
      - name: Checkout sentry
        uses: actions/checkout@v2
        with:
          repository: getsentry/sentry
          path: sentry

      - uses: actions/setup-python@v2
        with:
          python-version: 3.6

      - name: Setup steps
        id: setup
        run: |
          pip install --upgrade pip wheel
          echo "::set-output name=pip-cache-dir::$(pip cache dir)"
          # We cannot execute actions that are not placed under .github of the main repo
          mkdir -p .github/actions/setup-sentry/
          cp sentry/.github/actions/setup-sentry/action.yml .github/actions/setup-sentry/action.yml

      - name: Sentry's pip cache
        uses: actions/cache@v2
        with:
          path: ${{ steps.setup.outputs.pip-cache-dir }}
          key: sentry-deps-${{ hashFiles('sentry/requirements**.txt') }}
          restore-keys: sentry-deps-

      - name: Setup Sentry
        uses: ./.github/actions/setup-sentry
        with:
          workdir: sentry
          snuba: true
          kafka: true

      - name: Run Sentry's Symbolicator integration tests
        working-directory: sentry
        run: |
          docker build -t us.gcr.io/sentryio/symbolicator:$GITHUB_SHA .
          docker run \
            -d \
            -v $PWD/config/symbolicator/:/etc/symbolicator \
            --network host \
            --name symbolicator \
            us.gcr.io/sentryio/symbolicator:$GITHUB_SHA \
            run -c /etc/symbolicator/config.yml
          docker ps -a
          # cargo run -- run &
          make test-symbolicator

  doc-comments:
    name: Rust doc comments
    runs-on: ubuntu-latest
    env:
      RUSTDOCFLAGS: -Dwarnings
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Install rust stable toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          components: rust-docs
          override: true

      - name: Cache rust cargo artifacts
        uses: swatinem/rust-cache@v1

      - uses: actions-rs/cargo@v1
        with:
          command: doc
          args: --workspace --all-features --document-private-items --no-deps

  docs:
    name: Build docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Setup python dependencies
        run: pip install --upgrade mkdocs mkdocs-material pygments

      - name: Build Docs
        run: mkdocs build
