format_version: 10
pipelines:
  rollback-symbolicator:
    display_order: 1
    environment_variables:
      ALL_PIPELINE_FLAGS: --pipeline=deploy-symbolicator-s4s --pipeline=deploy-symbolicator-us --pipeline=deploy-symbolicator-customer-1 --pipeline=deploy-symbolicator-customer-2 --pipeline=deploy-symbolicator
      GOCD_ACCESS_TOKEN: '{{SECRET:[devinfra][gocd_access_token]}}'
      REGION_PIPELINE_FLAGS: --pipeline=deploy-symbolicator-s4s --pipeline=deploy-symbolicator-us --pipeline=deploy-symbolicator-customer-1 --pipeline=deploy-symbolicator-customer-2
      ROLLBACK_MATERIAL_NAME: symbolicator_repo
      ROLLBACK_STAGE: deploy_primary
    group: symbolicator
    lock_behavior: unlockWhenFinished
    materials:
      deploy-symbolicator-customer-2-pipeline-complete:
        pipeline: deploy-symbolicator-customer-2
        stage: pipeline-complete
    stages:
      - pause_pipelines:
          approval:
            type: manual
          jobs:
            rollback:
              elastic_profile_id: symbolicator
              tasks:
                - script: |
                    ##!/bin/bash

                    ## Note: $ALL_PIPELINE_FLAGS has no quoting, for word expansion
                    ## shellcheck disable=SC2086
                    if [[ "${ALL_PIPELINE_FLAGS:-}" ]]; then
                      set -- $ALL_PIPELINE_FLAGS
                    fi

                    ## Pause all pipelines in the pipedream
                    gocd-pause-and-cancel-pipelines \
                      --pause-message="This pipeline is being rolled back, please check with team before un-pausing." \
                      "$@"
      - start_rollback:
          jobs:
            rollback:
              elastic_profile_id: symbolicator
              tasks:
                - script: "##!/bin/bash\n\n## Note: $REGION_PIPELINE_FLAGS has no quoting, for word expansion\n## shellcheck disable=SC2086\nif [[ \"${REGION_PIPELINE_FLAGS:-}\" ]]; then\n  set -- $REGION_PIPELINE_FLAGS\nfi\n\n## Get sha from the given pipeline run to deploy to all pipedream pipelines.\nsha=$(gocd-sha-for-pipeline --material-name=\"${ROLLBACK_MATERIAL_NAME}\")\n\necho \"\U0001F4D1 Rolling back to sha: ${sha}\"\n\ngocd-emergency-deploy \\\n  --material-name=\"${ROLLBACK_MATERIAL_NAME}\" \\\n  --commit-sha=\"${sha}\" \\\n  --deploy-stage=\"${ROLLBACK_STAGE}\" \\\n  --pause-message=\"This pipeline was rolled back, please check with team before un-pausing.\" \\\n  \"$@\"\n"
